<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>DUAL // UNO — Orbital Core</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#050505">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>

  <!-- Fontes e Ícones -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Dependências: Purify para Segurança e PostCSS para Scoping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/postcss-selector-parser@7.1.1/dist/index.umd.js"></script>

  <style>
    :root {
      --bg: #050505;
      --surface: #0c0c0e;
      --border: rgba(255,255,255,0.08);
      --accent: #00f2ff;
      --purple: #bd00ff;
      --warn: #ff4d4d;
      --gold: #ffd700;
      --font-ui: 'Inter', sans-serif;
      --font-code: 'JetBrains Mono', monospace;
      --ease: cubic-bezier(0.23, 1, 0.32, 1);
      --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);

      /* Gradientes para loaders */
      --grad-a: #00f2ff;
      --grad-b: #bd00ff;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body {
      margin: 0; padding: 0; min-height: 100vh;
      background: var(--bg); color: #fff; font-family: var(--font-ui);
      display: flex; flex-direction: column; align-items: center;
      overflow-x: hidden;
      background-image:
        radial-gradient(circle at 50% 50%, #111118 0%, #000 100%),
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 100% 100%, 40px 40px, 40px 40px;
      transition: background 0.4s;
    }

    /* ==== NUCLEUS (Orbital UI) ==== */
    .nucleus-container {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5000; transition: all 0.7s var(--ease-elastic);
      display: flex; flex-direction: column; align-items: center; gap: 15px;
    }
    body.active .nucleus-container { top: 60px; transform: translate(-50%, 0) scale(0.8); }

    .nucleus {
      width: 80px; height: 80px; border-radius: 50%;
      background: #000; border: 2px solid #222;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; position: relative;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      transition: 0.3s;
    }
    .nucleus:hover { border-color: var(--accent); box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }

    .nucleus-ring {
      position: absolute; inset: -8px; border: 1px solid rgba(0,242,255,0.1);
      border-radius: 50%; border-top-color: var(--accent);
      animation: spin 3s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .nucleus-label {
      font-family: var(--font-code); font-size: 0.65rem; color: #555;
      text-transform: uppercase; letter-spacing: 2px;
    }
    body.active .nucleus-label { opacity: 0; }

    /* ==== CONTENT CONTAINER ==== */
    .uno-app {
      width: 100%; max-width: 780px; padding: 20px;
      margin-top: 140px; opacity: 0; transform: translateY(30px);
      transition: all 0.6s var(--ease); pointer-events: none;
      display: flex; flex-direction: column; gap: 15px;
    }
    body.active .uno-app { opacity: 1; transform: translateY(0); pointer-events: all; }

    /* ==== CORE CARDS ==== */
    .glass-card {
      background: rgba(15, 15, 20, 0.7); backdrop-filter: blur(18px);
      border: 1px solid var(--border); border-radius: 18px;
      padding: 18px; position: relative; overflow: hidden;
    }
    .glass-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
    }

    .header-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
    .brand { font-weight: 900; font-size: 1.1rem; letter-spacing: -1px; }
    .brand span { font-weight: 200; opacity: 0.6; }

    .clock-section { text-align: right; font-family: var(--font-code); }
    .clock-time { font-size: 1rem; font-weight: 700; color: var(--accent); }
    .clock-date { font-size: 0.6rem; color: #555; }

    /* ==== INPUTS & BUTTONS ==== */
    .input-group { position: relative; margin-bottom: 12px; }
    .main-input {
      width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border);
      padding: 12px 14px; border-radius: 12px; color: #fff;
      font-family: var(--font-code); transition: 0.3s;
    }
    .main-input:focus { border-color: var(--accent); background: #000; }

    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      flex: 1; min-width: 90px; height: 40px; border-radius: 10px;
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      color: rgba(255,255,255,0.8); font-size: 0.75rem; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; transition: 0.2s; text-transform: uppercase;
    }
    .btn:hover { background: rgba(255,255,255,0.06); color: #fff; }
    .btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,242,255,0.05); }
    .btn.primary { background: #fff; color: #000; border: none; }

    /* ==== MODULES AREA (ACORDEON -> CARDS) ==== */
    .modules-container { display: flex; flex-direction: column; gap: 12px; }
    .module-item {
      background: transparent; border-radius: 16px; overflow: visible; transition: transform 0.45s var(--ease), box-shadow 0.35s var(--ease);
      transform-origin: center top;
      perspective: 900px;
    }
    .module-head {
      padding: 12px 16px; display: flex; justify-content: space-between;
      align-items: center; cursor: pointer; border-radius: 14px;
      background: rgba(255,255,255,0.02); border: 1px solid var(--border);
      transition: background 0.2s;
    }
    .module-head:hover { background: rgba(255,255,255,0.03); }

    .module-body {
      max-height: 0; overflow: hidden; transition: max-height 0.45s var(--ease), padding 0.35s;
      border-top: none;
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.28));
      border-radius: 0 0 14px 14px;
    }

    /* quando abrir, o item "vira" em card e expande */
    .module-item.open {
      transform: translateY(-6px) scale(1.01);
      box-shadow: 0 12px 40px rgba(0,0,0,0.7), 0 4px 18px rgba(0,0,0,0.6);
      z-index: 30;
    }
    .module-item.open .module-head {
      border-bottom-left-radius: 0; border-bottom-right-radius: 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
    }
    .module-item.open .module-body {
      max-height: 800px; padding: 14px 16px 18px 16px;
    }

    /* card-face flip illusion (subtle) */
    .module-card-face {
      transform-origin: center;
      transform-style: preserve-3d;
      transition: transform 0.5s var(--ease);
    }
    .module-item.open .module-card-face { transform: rotateX(0deg); }
    .module-item .module-card-face { transform: rotateX(2deg); }

    .code-editor {
      width: 100%; min-height: 120px; background: #000; color: #0f0;
      font-family: var(--font-code); font-size: 0.8rem; padding: 12px;
      border: 1px solid #222; border-radius: 10px; resize: vertical;
    }

    /* small utilities inside module head */
    .module-actions { display:flex; gap:8px; align-items:center; margin-left:12px; }
    .tiny { font-size:0.72rem; opacity:0.9 }

    /* ==== RUNTIME OVERLAY ==== */
    #runtime-view {
      position: fixed; inset: 0; background: #000; z-index: 6000;
      transform: translateY(100%); transition: 0.5s var(--ease);
      display: flex; flex-direction: column;
    }
    #runtime-view.visible { transform: translateY(0); }
    .runtime-header {
      padding: 12px 16px; border-bottom: 1px solid #222;
      display: flex; justify-content: space-between; align-items: center;
    }

    /* Welcome overlay */
    .welcome-overlay {
      position: fixed; inset: 0; z-index: 7000; display: grid; place-items:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.5));
      transition: opacity 0.4s;
    }
    .welcome-card {
      width: min(720px, 92%); background: rgba(5,5,8,0.95); border-radius: 14px; padding: 22px;
      border: 1px solid rgba(255,255,255,0.04); text-align: left;
    }
    .welcome-card h2 { margin: 0 0 8px 0; font-size:1.2rem; }
    .welcome-card p { margin: 0 0 14px 0; color:#bbb; font-size:0.95rem; }

    /* idle notice */
    .idle-banner {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px;
      background: rgba(0,0,0,0.7); border-radius: 999px; padding: 8px 14px;
      border: 1px solid rgba(255,255,255,0.04); display:flex; gap:10px; align-items:center; z-index:8000;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    .idle-banner.hidden { display:none; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

    /* ===== loaders.css (suas regras) ===== */
    .di{ --di-size:40px; --di-stroke:2px; --di-gold: color-mix(in oklab, var(--grad-a) 60%, var(--grad-b) 40%);
      position:relative;width:var(--di-size);height:var(--di-size)}
    .di .ring{position:absolute;inset:0;border:var(--di-stroke) solid var(--di-gold);
      border-radius:50%;animation:di-spin 6s linear infinite}
    .di .stroke{position:absolute;left:50%;top:50%;width:62%;height:var(--di-stroke);
      background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transform:translate(-50%,-50%);
      border-radius:999px;animation:di-breathe 2.4s ease-in-out infinite}
    .di .dots{position:absolute;inset:0;transform:rotate(-90deg);animation:di-orbit 4.2s linear infinite}
    .di .dots i{--i:0;position:absolute;left:50%;top:50%;width:4px;height:4px;border-radius:50%;
      background:conic-gradient(var(--grad-a),var(--grad-b));
      -webkit-mask: radial-gradient(circle, #000 62%, transparent 63%);
      mask: radial-gradient(circle, #000 62%, transparent 63%);
      opacity:.85;transform:rotate(calc(var(--i)*51deg)) translate(calc(7px + var(--i)*2.2px)) rotate(calc(var(--i)*-51deg));
      animation:di-pulse 4.2s linear infinite;animation-delay:calc(var(--i)*.6s)}
    @keyframes di-orbit{to{transform:rotate(270deg)}}@keyframes di-spin{to{transform:rotate(360deg)}}
    @keyframes di-breathe{0%,100%{opacity:.9}50%{opacity:1}}
    @keyframes di-pulse{0%,70%{opacity:.55;transform:scale(.92)}76%,84%{opacity:1;transform:scale(1.12)}100%{opacity:.7;transform:scale(.96)}}

    /* responsive */
    @media (max-width:640px){
      .uno-app{ padding: 14px; margin-top:110px; max-width:420px }
      .btn { min-width:80px; height:36px; }
    }
  </style>
</head>
<body id="mainBody">

  <!-- WELCOME OVERLAY -->
  <div id="welcome" class="welcome-overlay" role="dialog" aria-modal="true">
    <div class="welcome-card glass-card">
      <h2>Bem-vindo ao DUAL // UNO</h2>
      <p>Sistema carregado. Aqui você pode colar, carregar, criar e executar módulos HTML seguros — ou no modo RAW se preferir. Clique em "Começar" para abrir a área principal.</p>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px">
        <button class="btn" id="skipWelcome"><i data-lucide="x"></i> Fechar</button>
        <button class="btn primary" id="startWelcome"><i data-lucide="play"></i> Começar</button>
      </div>
    </div>
  </div>

  <!-- ORBITAL NUCLEUS -->
  <div class="nucleus-container">
    <div class="nucleus" id="masterNucleus" onclick="app.toggle()">
      <div class="nucleus-ring"></div>
      <div id="nucleusIcon"><i data-lucide="zap" color="white"></i></div>
    </div>
    <span class="nucleus-label" id="nucleusStatus">Idle</span>
  </div>

  <!-- RUNTIME (Full Preview) -->
  <div id="runtime-view">
    <div class="runtime-header">
      <span style="font-family:var(--font-code); font-size:0.7rem; color:var(--accent)">RUNTIME EXECUTOR</span>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn" style="width:40px; min-width:auto" onclick="app.closeRuntime()">
          <i data-lucide="x"></i>
        </button>
      </div>
    </div>
    <div id="iframeContainer" style="flex:1; background:#fff"></div>
  </div>

  <!-- APP CONTENT -->
  <div class="uno-app" aria-live="polite">
    <div class="glass-card">
      <div class="header-info">
        <div class="brand">DUAL <span>// UNO</span></div>
        <div class="clock-section">
          <div class="clock-time" id="time">00:00</div>
          <div class="clock-date" id="date">--/--/--</div>
        </div>
      </div>

      <div class="input-group" style="display:flex; gap:8px;">
        <input type="text" class="main-input" id="userName" placeholder="Identidade do Operador..." autocomplete="off">
        <div style="display:flex; gap:8px;">
          <button class="btn" title="Upload" id="btnUpload" onclick="document.getElementById('fileInput').click()"><i data-lucide="upload"></i></button>
          <button class="btn" title="Colar" id="btnPaste"><i data-lucide="clipboard"></i></button>
          <button class="btn" title="Salvar documento" id="btnSaveDoc"><i data-lucide="download"></i></button>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" id="rawBtn" onclick="app.toggleRaw()">
          <i data-lucide="shield"></i> <span id="rawLabel">Safe</span>
        </button>
        <button class="btn" onclick="app.speakIdentity()">
          <i data-lucide="mic"></i> Voz
        </button>
        <button class="btn" onclick="app.toggleModule('creator')">
          <i data-lucide="plus"></i> Novo
        </button>
      </div>

      <!-- Módulo Criador -->
      <div class="module-item" id="mod-creator" style="margin-top:12px; display:none">
        <div class="module-head" onclick="this.parentElement.classList.toggle('open');">
          <div style="display:flex; align-items:center; gap:12px">
            <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));display:grid;place-items:center"><i data-lucide="file-plus" style="opacity:0.95"></i></div>
            <div style="display:flex; flex-direction:column">
              <span style="font-size:0.9rem; font-weight:700">Novo Módulo / Stack</span>
              <span style="font-size:0.66rem; color:#777">Cole HTML e cristalize</span>
            </div>
          </div>
          <i data-lucide="chevron-down" size="16"></i>
        </div>
        <div class="module-body">
          <div class="module-card-face">
            <textarea id="codeIn" class="code-editor" placeholder="Cole seu HTML/CSS/JS aqui..."></textarea>
            <div style="display:flex; gap:8px; margin-top:10px; align-items:center;">
              <input type="text" id="titleIn" placeholder="Título" style="flex:1; background:#111; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:8px">
              <button class="btn primary" onclick="app.saveStack()">Cristalizar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Módulo de CSS Live -->
    <div class="glass-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:0.75rem;font-weight:700">EDITOR DE AMBIENTE (CSS)</div>
        <div class="tiny">Preview aplicado</div>
      </div>
      <textarea id="cssIn" class="code-editor" style="height:80px; color:var(--accent)" placeholder="Ex: body { background: red; }"></textarea>
      <div class="btn-row" style="margin-top:10px">
        <button class="btn" onclick="app.applyCss()">Aplicar</button>
        <button class="btn" onclick="app.resetCss()">Reset</button>
      </div>
    </div>

    <!-- VAULT / STACKS -->
    <div id="vault" class="modules-container"></div>
  </div>

  <!-- hidden file input for upload -->
  <input id="fileInput" type="file" accept=".html,.htm,.txt" style="display:none" />

  <!-- idle banner -->
  <div id="idleBanner" class="idle-banner hidden" role="status" aria-hidden="true">
    <div class="di" style="margin-right:6px"><div class="ring"></div><div class="stroke"></div><div class="dots"><i style="--i:0"></i><i style="--i:1"></i><i style="--i:2"></i></div></div>
    <div style="display:flex;flex-direction:column">
      <div style="font-size:0.9rem;font-weight:700">Usuário nas quietes</div>
      <div style="font-size:0.75rem;color:#bbb">Atividade não detectada</div>
    </div>
    <div style="margin-left:12px">
      <button class="btn" style="min-width:48px;height:36px" onclick="app.awaken()"><i data-lucide="zap"></i></button>
    </div>
  </div>

  <script>
    // Core Logic
    const app = {
      state: {
        active: false,
        raw: false,
        stacks: JSON.parse(localStorage.getItem('uno_vault_v2') || '[]'),
        user: localStorage.getItem('uno_user') || '',
        idleTimer: null,
        idleTimeout: 60_000 // 60s -> idle
      },

      init() {
        lucide.createIcons();
        this.updateClock();
        setInterval(() => this.updateClock(), 1000);

        // welcome overlay controls
        document.getElementById('startWelcome').addEventListener('click', () => {
          document.getElementById('welcome').style.display = 'none';
          this.openMain();
        });
        document.getElementById('skipWelcome').addEventListener('click', () => {
          document.getElementById('welcome').style.display = 'none';
          this.openMain();
        });

        if (this.state.user) {
          document.getElementById('userName').value = this.state.user;
          this.checkTeslaVibe(this.state.user);
        }

        // user input
        document.getElementById('userName').addEventListener('input', (e) => {
          this.state.user = e.target.value;
          localStorage.setItem('uno_user', this.state.user);
          this.checkTeslaVibe(this.state.user);
          this.resetIdleTimer();
        });

        // paste button
        document.getElementById('btnPaste').addEventListener('click', () => this.pasteClipboard());
        // upload input
        document.getElementById('fileInput').addEventListener('change', (ev) => this.handleUpload(ev));
        // save doc button
        document.getElementById('btnSaveDoc').addEventListener('click', () => this.saveDocument());

        // global interaction to reset idle
        ['click','mousemove','keydown','touchstart'].forEach(ev => window.addEventListener(ev, () => this.resetIdleTimer()));

        this.renderVault();
        this.applyRawUI();

        // Carrega CSS salvo
        const savedCss = localStorage.getItem('uno_css');
        if(savedCss) {
          document.getElementById('cssIn').value = savedCss;
          this.applyCss();
        }

        this.resetIdleTimer();
      },

      openMain() {
        this.state.active = true;
        document.body.classList.add('active');
        document.getElementById('nucleusStatus').innerText = 'Active';
      },

      toggle() {
        this.state.active = !this.state.active;
        document.body.classList.toggle('active', this.state.active);
        document.getElementById('nucleusStatus').innerText = this.state.active ? 'Active' : 'Idle';
        this.speak(this.state.active ? "Sistema Dual On" : "Modo Furtivo");
      },

      toggleRaw() {
        this.state.raw = !this.state.raw;
        this.applyRawUI();
      },

      applyRawUI() {
        const btn = document.getElementById('rawBtn');
        const label = document.getElementById('rawLabel');
        btn.classList.toggle('active', this.state.raw);
        label.innerText = this.state.raw ? 'RAW' : 'SAFE';
        this.speak(this.state.raw ? "Protocolo Raw Ativado" : "Filtros de Segurança ativos");
      },

      updateClock() {
        const now = new Date();
        document.getElementById('time').innerText = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('date').innerText = now.toLocaleDateString('pt-BR');
      },

      checkTeslaVibe(name) {
        if(!name) return document.body.classList.remove('tesla-vibe');
        const sum = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
        let root = sum;
        while(root > 9) root = String(root).split('').reduce((a, b) => a + Number(b), 0);

        if([3, 6, 9].includes(root)) {
          document.body.classList.add('tesla-vibe');
        } else {
          document.body.classList.remove('tesla-vibe');
        }
      },

      toggleModule(id) {
        const el = document.getElementById(`mod-${id}`);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
        lucide.createIcons();
      },

      saveStack() {
        const content = document.getElementById('codeIn').value;
        const title = document.getElementById('titleIn').value || "Módulo s/ Nome";
        if(!content) return this.speak("Nenhum conteúdo para cristalizar");

        this.state.stacks.unshift({
          id: Date.now(),
          title,
          content,
          date: new Date().toLocaleString()
        });

        localStorage.setItem('uno_vault_v2', JSON.stringify(this.state.stacks));
        document.getElementById('codeIn').value = '';
        document.getElementById('titleIn').value = '';
        this.renderVault();
        this.toggleModule('creator');
        this.speak("Módulo cristalizado");
      },

      renderVault() {
        const container = document.getElementById('vault');
        if(this.state.stacks.length === 0) {
          container.innerHTML = '<div style="text-align:center; opacity:0.2; font-size:0.8rem; padding:20px">VAULT VAZIO</div>';
          return;
        }

        container.innerHTML = '';
        this.state.stacks.forEach(s => {
          const item = document.createElement('div');
          item.className = 'module-item';
          item.id = `stack-${s.id}`;
          item.innerHTML = `
            <div class="module-head" data-id="${s.id}">
              <div style="display:flex; align-items:center">
                <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));display:grid;place-items:center;margin-right:10px">
                  <i data-lucide="file-text" style="opacity:0.95"></i>
                </div>
                <div style="display:flex; flex-direction:column">
                  <span style="font-size:0.9rem; font-weight:700">${this.escapeHtml(s.title)}</span>
                  <span style="font-size:0.66rem; color:#777">${s.date}</span>
                </div>
              </div>
              <div style="display:flex;align-items:center">
                <div class="module-actions">
                  <button class="btn" data-act="run" title="Rodar" style="height:36px"><i data-lucide="play-circle"></i></button>
                  <button class="btn" data-act="paste" title="Colar no editor" style="height:36px"><i data-lucide="clipboard"></i></button>
                  <button class="btn" data-act="del" title="Apagar" style="height:36px"><i data-lucide="trash-2"></i></button>
                </div>
                <i data-lucide="chevron-down" style="margin-left:10px"></i>
              </div>
            </div>
            <div class="module-body">
              <div class="module-card-face">
                <div style="display:flex; justify-content:flex-end; margin-bottom:8px">
                  <div class="tiny" style="opacity:0.7; margin-right:auto">Preview / Conteúdo</div>
                </div>
                <textarea class="code-editor" readonly style="height:110px; font-size:0.75rem; opacity:0.85">${this.escapeHtml(s.content)}</textarea>
                <div style="display:flex; gap:8px; margin-top:10px">
                  <button class="btn" data-action-run style="height:36px">RODAR</button>
                  <button class="btn" data-action-download style="height:36px">BAIXAR</button>
                </div>
              </div>
            </div>
          `;
          container.appendChild(item);
        });

        lucide.createIcons();
        // wire interactions
        container.querySelectorAll('.module-head').forEach(head => {
          const item = head.parentElement;
          head.addEventListener('click', (ev) => {
            // prevent head clicks from triggering action buttons
            if (ev.target.closest('button')) return;
            const id = head.getAttribute('data-id');
            this.toggleAccordion(id);
          });

          head.querySelectorAll('button[data-act]').forEach(btn => {
            const act = btn.getAttribute('data-act');
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const id = head.getAttribute('data-id');
              if (act === 'run') this.runStack(Number(id));
              if (act === 'del') this.deleteStack(Number(id));
              if (act === 'paste') this.pasteToCreator(Number(id));
            });
          });
        });

        // action buttons inside body
        container.querySelectorAll('button[data-action-run]').forEach(b => {
          b.addEventListener('click', (e) => {
            const id = Number(e.target.closest('.module-item').id.replace('stack-',''));
            this.runStack(id);
          });
        });
        container.querySelectorAll('button[data-action-download]').forEach(b => {
          b.addEventListener('click', (e) => {
            const id = Number(e.target.closest('.module-item').id.replace('stack-',''));
            const s = this.state.stacks.find(x => x.id === id);
            this.downloadFile(`${s.title.replace(/\s+/g,'_') || 'module'}.html`, s.content);
          });
        });
      },

      // open accordion: close others, open this one
      toggleAccordion(id) {
        const target = document.getElementById(`stack-${id}`);
        if(!target) return;
        const isOpen = target.classList.contains('open');
        // close all
        document.querySelectorAll('.module-item.open').forEach(el => el.classList.remove('open'));
        if(!isOpen) {
          target.classList.add('open');
          // scroll into view a bit
          setTimeout(()=> target.scrollIntoView({behavior:'smooth', block:'center'}), 80);
        }
      },

      runStack(id) {
        const s = this.state.stacks.find(x => x.id === id);
        if(!s) return this.speak("Módulo não encontrado");
        const container = document.getElementById('iframeContainer');
        const view = document.getElementById('runtime-view');

        const iframe = document.createElement('iframe');
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";

        if(!this.state.raw) {
          iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-modals');
        }

        container.innerHTML = '';
        container.appendChild(iframe);

        // Purify content if needed
        let cleanContent = s.content;
        try {
          cleanContent = this.state.raw ? s.content : DOMPurify.sanitize(s.content, { ADD_TAGS: ["script", "style"], ADD_ATTR: ["onclick"] });
        } catch(e) {
          console.warn('Sanitize falhou, usando conteúdo bruto', e);
        }

        iframe.srcdoc = cleanContent;
        view.classList.add('visible');
      },

      closeRuntime() {
        document.getElementById('runtime-view').classList.remove('visible');
        setTimeout(() => { document.getElementById('iframeContainer').innerHTML = ''; }, 520);
      },

      deleteStack(id) {
        if(!confirm("Deletar módulo?")) return;
        this.state.stacks = this.state.stacks.filter(s => s.id !== id);
        localStorage.setItem('uno_vault_v2', JSON.stringify(this.state.stacks));
        this.renderVault();
        this.speak("Módulo apagado");
      },

      applyCss() {
        const css = document.getElementById('cssIn').value;
        let styleTag = document.getElementById('injected-env-css');
        if(!styleTag) {
          styleTag = document.createElement('style');
          styleTag.id = 'injected-env-css';
          document.head.appendChild(styleTag);
        }
        styleTag.textContent = css;
        localStorage.setItem('uno_css', css);
        this.speak("CSS aplicado");
      },

      resetCss() {
        document.getElementById('cssIn').value = '';
        this.applyCss();
      },

      speak(text) {
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'pt-BR'; u.rate = 1.05;
        window.speechSynthesis.speak(u);
      },

      speakIdentity() {
        const name = this.state.user || "Operador Desconhecido";
        this.speak(`Identidade confirmada como ${name}.`);
      },

      /* --------- upload / paste / save features ---------- */

      pasteClipboard() {
        if(!navigator.clipboard) return this.speak("Clipboard não disponível");
        navigator.clipboard.readText().then(text => {
          if(!text) return this.speak("Área de transferência vazia");
          // open creator and paste content
          const creator = document.getElementById('mod-creator');
          creator.style.display = 'block';
          if(!creator.classList.contains('open')) creator.classList.add('open');
          document.getElementById('codeIn').value = text;
          lucide.createIcons();
          this.speak("Conteúdo colado");
        }).catch(err => {
          console.error(err);
          this.speak("Falha ao colar. Permissão negada?");
        });
      },

      pasteToCreator(stackId) {
        const s = this.state.stacks.find(x => x.id === stackId);
        if(!s) return;
        const creator = document.getElementById('mod-creator');
        creator.style.display = 'block';
        if(!creator.classList.contains('open')) creator.classList.add('open');
        document.getElementById('codeIn').value = s.content;
        document.getElementById('titleIn').value = s.title;
        this.speak("Conteúdo copiado para editor");
      },

      handleUpload(ev) {
        const file = ev.target.files && ev.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          // colocar no criador
          document.getElementById('mod-creator').style.display = 'block';
          if(!document.getElementById('mod-creator').classList.contains('open')) document.getElementById('mod-creator').classList.add('open');
          document.getElementById('codeIn').value = String(text);
          document.getElementById('titleIn').value = file.name;
          this.speak("Arquivo carregado");
        };
        reader.readAsText(file);
        // reset input
        ev.target.value = '';
      },

      saveDocument() {
        // se houver módulo aberto, salva o módulo; senão salva todo vault como pacote
        const open = document.querySelector('.module-item.open');
        if(open) {
          const id = Number(open.id.replace('stack-',''));
          const s = this.state.stacks.find(x => x.id === id);
          if(s) return this.downloadFile(`${s.title.replace(/\s+/g,'_') || 'module'}.html`, s.content);
        }
        // salva todo vault concatenado
        const all = this.state.stacks.map(s => `<!-- ${s.title} — ${s.date} -->\n${s.content}\n\n`).join('\n');
        this.downloadFile(`vault_${new Date().toISOString().split('T')[0]}.html`, all || '<!-- VAULT VAZIO -->');
      },

      downloadFile(filename, content) {
        const blob = new Blob([content], {type: 'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        this.speak("Download iniciado");
      },

      /* --------- idle detection (Usuário nas quietes) ---------- */
      resetIdleTimer() {
        const banner = document.getElementById('idleBanner');
        banner.classList.add('hidden');
        if(this.state.idleTimer) clearTimeout(this.state.idleTimer);
        this.state.idleTimer = setTimeout(() => this.onIdle(), this.state.idleTimeout);
      },

      onIdle() {
        const banner = document.getElementById('idleBanner');
        banner.classList.remove('hidden');
        this.speak("Usuário nas quietes");
      },

      awaken() {
        this.resetIdleTimer();
        document.getElementById('idleBanner').classList.add('hidden');
        this.speak("Ativando sistema");
      },

      /* small helpers */
      escapeHtml(str) {
        if(!str) return '';
        return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
      }
    };

    window.onload = () => app.init();
  </script>
</body>
</html>